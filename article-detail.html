<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - æ¸¸æˆç©å®¶å†…å®¹å‘å¸ƒå¹³å°</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/post-detail.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/post.js"></script>
    <script src="js/init-mock-data.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1>æ¸¸æˆç©å®¶å¹³å°</h1>
            </div>
            <div class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="posts.html">å¸–å­</a>
                <a href="articles.html">æ–‡ç« </a>
                <a href="create-post.html" id="create-post-btn" class="create-btn">å‘å¸ƒå†…å®¹</a>
                <a href="login.html" id="login-btn">ç™»å½•</a>
                <a href="register.html" id="register-btn">æ³¨å†Œ</a>
                <div id="user-profile" class="hidden">
                    <img id="navbar-avatar" src="" alt="ç”¨æˆ·å¤´åƒ" style="display: none; width: 32px; height: 32px; border-radius: 50%; margin-right: 8px;">
                    <i class="fas fa-user"></i>
                    <span id="username-display"></span>
                    <button id="logout-btn" onclick="handleLogout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- æ–‡ç« è¯¦æƒ…åŒºåŸŸ -->
    <main class="article-detail-container">
        <div class="container">
            <!-- æ–‡ç« å¤´éƒ¨ -->
            <div class="article-header">
                <span class="article-category" id="article-category"></span>
                <h1 id="article-title"></h1>
                
                <div class="article-meta">
                    <div class="article-author">
                        <div class="user-avatar" id="author-avatar"></div>
                        <span id="author-name"></span>
                    </div>
                    <div class="article-stats">
                        <span><i>ğŸ‘</i> <span id="article-views">0</span></span>
                        <span><i>ğŸ‘</i> <span id="article-likes">0</span></span>
                        <span><i>ğŸ’¬</i> <span id="article-comments-count">0</span></span>
                    </div>
                    <div class="article-date" id="article-date"></div>
                </div>
            </div>

            <!-- æ–‡ç« å†…å®¹ -->
            <div class="article-content" id="article-content">
                <!-- æ–‡ç« å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <!-- ç‚¹èµå’Œæ“ä½œåŒºåŸŸ -->
            <div class="article-actions">
                <button id="like-btn" class="action-btn">
                    <i>ğŸ‘</i> ç‚¹èµ
                </button>
                <button id="share-btn" class="action-btn">
                    <i>ğŸ“¤</i> åˆ†äº«
                </button>
            </div>

            <!-- è¯„è®ºåŒºåŸŸ -->
            <div class="comments-section">
                <h3>è¯„è®º</h3>
                
                <!-- è¯„è®ºè¡¨å• -->
                <div class="comment-form" id="comment-form">
                    <textarea id="comment-content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3"></textarea>
                    <button id="submit-comment" class="btn-primary">å‘å¸ƒè¯„è®º</button>
                </div>

                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div id="comments-list" class="comments-list">
                    <!-- è¯„è®ºå°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h4>å…³äºæˆ‘ä»¬</h4>
                    <p>æ¸¸æˆç©å®¶å†…å®¹å‘å¸ƒå¹³å°ï¼Œè¿æ¥å…¨çƒæ¸¸æˆçˆ±å¥½è€…</p>
                </div>
                <div class="footer-links">
                    <h4>å¿«é€Ÿé“¾æ¥</h4>
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="posts.html">å¸–å­</a>
                    <a href="articles.html">æ–‡ç« </a>
                    <a href="#">è”ç³»æˆ‘ä»¬</a>
                </div>
                <div class="footer-social">
                    <h4>å…³æ³¨æˆ‘ä»¬</h4>
                    <a href="#" class="social-link">å¾®åš</a>
                    <a href="#" class="social-link">å¾®ä¿¡</a>
                    <a href="#" class="social-link">Discord</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 æ¸¸æˆç©å®¶å†…å®¹å‘å¸ƒå¹³å°. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            </div>
        </div>
    </footer>

    <script>
        // è·å–URLå‚æ•°
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                id: params.get('id')
            };
        }

        // åŠ è½½æ–‡ç« è¯¦æƒ…
        function loadArticleDetail() {
            const params = getUrlParams();
            if (!params.id) {
                alert('æ–‡ç« IDä¸å­˜åœ¨');
                window.location.href = 'articles.html';
                return;
            }

            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const article = posts.find(p => p.id === params.id && p.contentType === 'article');

            if (!article) {
                alert('æ–‡ç« ä¸å­˜åœ¨');
                window.location.href = 'articles.html';
                return;
            }

            // æ›´æ–°æµè§ˆé‡
            article.views = (article.views || 0) + 1;
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));

            // å¡«å……æ–‡ç« å†…å®¹
            document.getElementById('article-category').textContent = article.category;
            document.getElementById('article-title').textContent = article.title;
            
            // æ„å»ºæ–‡ç« å†…å®¹ï¼ŒåŒ…æ‹¬é“¾æ¥
            let contentHTML = `<p>${article.content.replace(/\n/g, '<br>')}</p>`;
            
            // å¦‚æœæœ‰é“¾æ¥ï¼Œæ·»åŠ é“¾æ¥æ˜¾ç¤º
            if (article.links && article.links.length > 0) {
                contentHTML += `
                <div class="article-links">
                    <h4>ç›¸å…³é“¾æ¥</h4>
                    <div class="links-container">
                        ${article.links.map(link => 
                            `<a href="${link}" target="_blank" class="article-link">
                                <span class="link-icon">ğŸ”—</span>
                                <span class="link-text">${new URL(link).hostname}</span>
                            </a>`
                        ).join('')}
                    </div>
                </div>
                `;
            }
            
            document.getElementById('article-content').innerHTML = contentHTML;
            document.getElementById('article-views').textContent = article.views;
            document.getElementById('article-likes').textContent = article.likes || 0;
            document.getElementById('article-comments-count').textContent = (article.comments || []).length;
            document.getElementById('article-date').textContent = new Date(article.createdAt).toLocaleString('zh-CN');

            // ä½œè€…ä¿¡æ¯
            const authorAvatar = document.getElementById('author-avatar');
            const bgColor = getRandomColor();
            authorAvatar.innerHTML = `<img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='${encodeURIComponent(bgColor)}'/><circle cx='50' cy='40' r='10' fill='white'/><path d='M30,70 Q50,85 70,70' fill='white'/></svg>" alt="${article.author.username}">`;
            document.getElementById('author-name').textContent = article.author.username;
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯æ–‡ç« ä½œè€…ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            if (currentUser.id === article.author.id) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸ åˆ é™¤æ–‡ç« ';
                deleteBtn.onclick = () => handleDeleteArticle(article.id);
                document.querySelector('.article-actions').appendChild(deleteBtn);
            }

            // åŠ è½½è¯„è®º
            loadComments(article.comments || []);
            
            // æ›´æ–°ç‚¹èµæŒ‰é’®çŠ¶æ€
            updateLikeButton(article);
        }

        // å¤„ç†åˆ é™¤æ–‡ç« 
        function handleDeleteArticle(articleId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½åˆ é™¤æ–‡ç« ');
                return;
            }
            
            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const articleIndex = posts.findIndex(p => p.id === articleId);
            
            if (articleIndex === -1) {
                alert('æ–‡ç« ä¸å­˜åœ¨');
                return;
            }
            
            const article = posts[articleIndex];
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯æ–‡ç« ä½œè€…
            if (currentUser.id !== article.author.id) {
                alert('æ‚¨åªèƒ½åˆ é™¤è‡ªå·±å‘å¸ƒçš„æ–‡ç« ');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            // åˆ é™¤æ–‡ç« 
            posts.splice(articleIndex, 1);
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('æ–‡ç« åˆ é™¤æˆåŠŸ');
            
            // è·³è½¬åˆ°æ–‡ç« åˆ—è¡¨é¡µé¢
            window.location.href = 'articles.html';
        }

        // åŠ è½½è¯„è®º
        function loadComments(comments) {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';

            if (comments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments"><p>æš‚æ— è¯„è®º</p></div>';
                return;
            }

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-author">
                            <div class="user-avatar">
                                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='${encodeURIComponent(getRandomColor())}'/><circle cx='50' cy='40' r='10' fill='white'/><path d='M30,70 Q50,85 70,70' fill='white'/></svg>" alt="${comment.author.username}">
                            </div>
                            <span class="username">${comment.author.username}</span>
                        </div>
                        <span class="comment-date">${new Date(comment.createdAt).toLocaleString('zh-CN')}</span>
                    </div>
                    <div class="comment-content">
                        <p>${comment.content}</p>
                    </div>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        // æ›´æ–°ç‚¹èµæŒ‰é’®çŠ¶æ€
        function updateLikeButton(article) {
            const likeBtn = document.getElementById('like-btn');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                likeBtn.disabled = false;
                likeBtn.innerHTML = '<i>ğŸ‘</i> ç‚¹èµ';
                return;
            }

            const userIndex = article.likedBy ? article.likedBy.indexOf(currentUser.id) : -1;
            
            if (userIndex === -1) {
                likeBtn.innerHTML = '<i>ğŸ‘</i> ç‚¹èµ';
            } else {
                likeBtn.innerHTML = '<i>ğŸ‘</i> å–æ¶ˆç‚¹èµ';
            }
        }

        // å¤„ç†ç‚¹èµ
        function handleLike() {
            const params = getUrlParams();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµ');
                return;
            }

            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const articleIndex = posts.findIndex(p => p.id === params.id);
            
            if (articleIndex === -1) return;

            const article = posts[articleIndex];
            
            // åˆå§‹åŒ–likedByæ•°ç»„
            if (!article.likedBy) article.likedBy = [];
            
            const userIndex = article.likedBy.indexOf(currentUser.id);
            
            if (userIndex === -1) {
                // ç‚¹èµ
                article.likedBy.push(currentUser.id);
                article.likes = (article.likes || 0) + 1;
            } else {
                // å–æ¶ˆç‚¹èµ
                article.likedBy.splice(userIndex, 1);
                article.likes = Math.max(0, (article.likes || 0) - 1);
            }
            
            // ä¿å­˜æ•°æ®
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));
            
            // æ›´æ–°UI
            document.getElementById('article-likes').textContent = article.likes;
            updateLikeButton(article);
        }

        // å¤„ç†è¯„è®ºæäº¤
        function handleCommentSubmit() {
            const params = getUrlParams();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const commentContent = document.getElementById('comment-content').value.trim();
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½è¯„è®º');
                return;
            }

            if (!commentContent) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const articleIndex = posts.findIndex(p => p.id === params.id);
            
            if (articleIndex === -1) return;

            const article = posts[articleIndex];
            
            // åˆå§‹åŒ–è¯„è®ºæ•°ç»„
            if (!article.comments) article.comments = [];

            // æ·»åŠ æ–°è¯„è®º
            const newComment = {
                id: Date.now().toString(),
                content: commentContent,
                author: {
                    id: currentUser.id,
                    username: currentUser.username
                },
                createdAt: new Date().toISOString()
            };

            article.comments.unshift(newComment);

            // ä¿å­˜æ•°æ®
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));
            
            // æ›´æ–°UI
            document.getElementById('comment-content').value = '';
            document.getElementById('article-comments-count').textContent = article.comments.length;
            loadComments(article.comments);
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¹¶æ›´æ–°currentUserå˜é‡
            if (typeof checkUserLogin === 'function') {
                checkUserLogin();
            } else {
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    updateUILoggedIn();
                } else {
                    updateUILoggedOut();
                }
            }

            // åŠ è½½æ–‡ç« è¯¦æƒ…
            loadArticleDetail();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('like-btn').addEventListener('click', handleLike);
            document.getElementById('submit-comment').addEventListener('click', handleCommentSubmit);
        });
    </script>
</body>
</html>