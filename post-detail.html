<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸–å­è¯¦æƒ… - æ¸¸æˆç©å®¶å†…å®¹å‘å¸ƒå¹³å°</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/post-detail.css">
    <script src="js/auth.js"></script>
    <script src="js/post.js"></script>
    <script src="js/init-mock-data.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1><a href="index.html" style="text-decoration: none; color: #3a3a3a;">æ¸¸æˆç©å®¶å¹³å°</a></h1>
            </div>
            <div class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="posts.html">å¸–å­</a>
                <a href="#" id="articles-link">æ–‡ç« </a>
                <a href="login.html" id="login-nav">ç™»å½•</a>
                <a href="register.html" id="register-nav">æ³¨å†Œ</a>
                <div id="user-profile" style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #e2e8f0; display: flex; align-items: center; justify-content: center; border: 2px solid #4a90e2;">
                            <img id="navbar-avatar" src="" alt="ç”¨æˆ·å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover;">
                            <i class="fas fa-user" style="color: #4a90e2; font-size: 20px;"></i>
                        </div>
                        <span id="username-display" style="color: #1a1a1a; font-weight: 700; font-size: 16px;"></span>
                    </div>
                    <button id="logout-btn" style="background: #ff4757; color: #ffffff; border: 0; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
                <a href="#" id="logout-nav" style="display: none;">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <!-- å¸–å­è¯¦æƒ…åŒºåŸŸ -->
    <section class="post-detail-section">
        <div class="container">
            <div class="post-detail-header">
                <span class="post-category" id="post-category"></span>
                <h1 id="post-title"></h1>
                <div class="post-meta">
                    <div class="post-author">
                        <div class="user-avatar" id="author-avatar"></div>
                        <span id="author-name"></span>
                    </div>
                    <div class="post-stats">
                        <span><i>ğŸ‘</i> <span id="post-views">0</span></span>
                        <span><i>ğŸ‘</i> <span id="post-likes">0</span></span>
                        <span><i>ğŸ’¬</i> <span id="post-comments-count">0</span></span>
                    </div>
                    <div class="post-date" id="post-date"></div>
                </div>
            </div>

            <div class="post-content" id="post-content">
                <!-- å¸–å­å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <!-- ç‚¹èµå’Œæ“ä½œåŒºåŸŸ -->
            <div class="post-actions">
                <button id="like-btn" class="action-btn">
                    <i>ğŸ‘</i> ç‚¹èµ
                </button>
                <button id="share-btn" class="action-btn">
                    <i>ğŸ“¤</i> åˆ†äº«
                </button>
            </div>

            <!-- è¯„è®ºåŒºåŸŸ -->
            <div class="comments-section">
                <h3>è¯„è®º</h3>
                
                <!-- è¯„è®ºè¡¨å• -->
                <div class="comment-form" id="comment-form">
                    <textarea id="comment-content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3"></textarea>
                    <button id="submit-comment" class="btn-primary">å‘å¸ƒè¯„è®º</button>
                </div>

                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div class="comments-list" id="comments-list">
                    <!-- è¯„è®ºå°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </section>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h4>å…³äºæˆ‘ä»¬</h4>
                    <p>æ¸¸æˆç©å®¶å†…å®¹å‘å¸ƒå¹³å°ï¼Œè¿æ¥å…¨çƒæ¸¸æˆçˆ±å¥½è€…</p>
                </div>
                <div class="footer-links">
                    <h4>å¿«é€Ÿé“¾æ¥</h4>
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="posts.html">å¸–å­</a>
                    <a href="#">æ–‡ç« </a>
                    <a href="#">è”ç³»æˆ‘ä»¬</a>
                </div>
                <div class="footer-social">
                    <h4>å…³æ³¨æˆ‘ä»¬</h4>
                    <a href="#" class="social-link">å¾®åš</a>
                    <a href="#" class="social-link">å¾®ä¿¡</a>
                    <a href="#" class="social-link">Discord</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 æ¸¸æˆç©å®¶å†…å®¹å‘å¸ƒå¹³å°. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            </div>
        </div>
    </footer>

    <script>
        // è·å–URLå‚æ•°
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                id: params.get('id')
            };
        }

        // åŠ è½½å¸–å­è¯¦æƒ…
        function loadPostDetail() {
            const params = getUrlParams();
            if (!params.id) {
                alert('å¸–å­IDæ— æ•ˆ');
                window.location.href = 'posts.html';
                return;
            }

            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const post = posts.find(p => p.id === params.id);

            if (!post) {
                alert('å¸–å­ä¸å­˜åœ¨');
                window.location.href = 'posts.html';
                return;
            }

            // æ›´æ–°å¸–å­æµè§ˆé‡
            post.views = (post.views || 0) + 1;
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));

            // æ˜¾ç¤ºå¸–å­å†…å®¹
            document.getElementById('post-title').textContent = post.title;
            document.getElementById('post-category').textContent = post.category;
            document.getElementById('post-content').textContent = post.content;
            document.getElementById('post-views').textContent = post.views || 0;
            document.getElementById('post-likes').textContent = post.likes || 0;
            document.getElementById('post-comments-count').textContent = (post.comments || []).length;
            document.getElementById('post-date').textContent = new Date(post.createdAt).toLocaleDateString('zh-CN');
            document.getElementById('author-name').textContent = post.author.username;

            // æ˜¾ç¤ºç›¸å…³é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (post.links && post.links.length > 0) {
                const linksContainer = document.createElement('div');
                linksContainer.className = 'article-links';
                
                let linksHTML = '<h4>ç›¸å…³é“¾æ¥</h4><div class="links-container">';
                
                post.links.forEach(link => {
                    try {
                        const url = new URL(link);
                        const domain = url.hostname;
                        linksHTML += `
                            <a href="${link}" target="_blank" class="article-link">
                                <span class="link-icon">ğŸ”—</span>
                                <span class="link-text">${domain}</span>
                            </a>
                        `;
                    } catch (e) {
                        // å¦‚æœURLæ— æ•ˆï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹é“¾æ¥
                        linksHTML += `
                            <a href="${link}" target="_blank" class="article-link">
                                <span class="link-icon">ğŸ”—</span>
                                <span class="link-text">${link}</span>
                            </a>
                        `;
                    }
                });
                
                linksHTML += '</div>';
                linksContainer.innerHTML = linksHTML;
                
                // å°†é“¾æ¥å®¹å™¨æ’å…¥åˆ°å¸–å­å†…å®¹ä¹‹å
                const postContent = document.getElementById('post-content');
                postContent.parentNode.insertBefore(linksContainer, postContent.nextSibling);
            }

            // ç”Ÿæˆä½œè€…å¤´åƒ
            const bgColor = getRandomColor();
            document.getElementById('author-avatar').innerHTML = `
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='${encodeURIComponent(bgColor)}'/><circle cx='50' cy='40' r='10' fill='white'/><path d='M30,70 Q50,85 70,70' fill='white'/></sv...
            `;
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯å¸–å­ä½œè€…ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            if (currentUser.id === post.author.id) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸ åˆ é™¤å¸–å­';
                deleteBtn.onclick = () => handleDeletePost(post.id);
                document.querySelector('.post-actions').appendChild(deleteBtn);
            }

            // åŠ è½½è¯„è®º
            loadComments(post.comments || []);

            // è®¾ç½®ç‚¹èµæŒ‰é’®çŠ¶æ€
            updateLikeButton(post);
        }

        // å¤„ç†åˆ é™¤å¸–å­
        function handleDeletePost(postId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½åˆ é™¤å¸–å­');
                return;
            }
            
            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const postIndex = posts.findIndex(p => p.id === postId);
            
            if (postIndex === -1) {
                alert('å¸–å­ä¸å­˜åœ¨');
                return;
            }
            
            const post = posts[postIndex];
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯å¸–å­ä½œè€…
            if (currentUser.id !== post.author.id) {
                alert('æ‚¨åªèƒ½åˆ é™¤è‡ªå·±å‘å¸ƒçš„å¸–å­');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            // åˆ é™¤å¸–å­
            posts.splice(postIndex, 1);
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('å¸–å­åˆ é™¤æˆåŠŸ');
            
            // è·³è½¬åˆ°å¸–å­åˆ—è¡¨é¡µé¢
            window.location.href = 'posts.html';
        }

        // åŠ è½½è¯„è®º
        function loadComments(comments) {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';

            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="no-comments">æš‚æ— è¯„è®º</p>';
                return;
            }

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-item';
                
                const bgColor = getRandomColor();
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-author">
                            <div class="user-avatar">
                                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='${encodeURIComponent(bgColor)}'/><circle cx='50' cy='40' r='10' fill='white'/><path d='M30,70 Q50,85 70,70' fill='white'/></svg>" alt="${comment.author.username}">
                            </div>
                            <span>${comment.author.username}</span>
                        </div>
                        <span class="comment-date">${new Date(comment.createdAt).toLocaleDateString('zh-CN')}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                `;
                
                commentsList.appendChild(commentElement);
            });
        }

        // æ›´æ–°ç‚¹èµæŒ‰é’®çŠ¶æ€
        function updateLikeButton(post) {
            const likeBtn = document.getElementById('like-btn');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                likeBtn.disabled = true;
                likeBtn.title = 'è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµ';
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ
            const hasLiked = post.likedBy && post.likedBy.includes(currentUser.id);
            if (hasLiked) {
                likeBtn.classList.add('liked');
                likeBtn.innerHTML = '<i>ğŸ‘</i> å·²ç‚¹èµ';
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.innerHTML = '<i>ğŸ‘</i> ç‚¹èµ';
            }
        }

        // å¤„ç†ç‚¹èµ
        function handleLike() {
            const params = getUrlParams();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµ');
                return;
            }

            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const postIndex = posts.findIndex(p => p.id === params.id);
            
            if (postIndex === -1) return;

            const post = posts[postIndex];
            
            // åˆå§‹åŒ–ç‚¹èµç›¸å…³å­—æ®µ
            if (!post.likes) post.likes = 0;
            if (!post.likedBy) post.likedBy = [];

            const userIndex = post.likedBy.indexOf(currentUser.id);
            
            if (userIndex === -1) {
                // ç‚¹èµ
                post.likes += 1;
                post.likedBy.push(currentUser.id);
            } else {
                // å–æ¶ˆç‚¹èµ
                post.likes -= 1;
                post.likedBy.splice(userIndex, 1);
            }

            // ä¿å­˜æ•°æ®
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));
            
            // æ›´æ–°UI
            document.getElementById('post-likes').textContent = post.likes;
            updateLikeButton(post);
            showNotification(userIndex === -1 ? 'ç‚¹èµæˆåŠŸï¼' : 'å·²å–æ¶ˆç‚¹èµ', 'success');
        }

        // å¤„ç†è¯„è®ºæäº¤
        function handleCommentSubmit() {
            const params = getUrlParams();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const commentContent = document.getElementById('comment-content').value.trim();
            
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½è¯„è®º');
                return;
            }

            if (!commentContent) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            const localStorageData = JSON.parse(localStorage.getItem('posts')) || {};
            const posts = localStorageData.posts || [];
            const postIndex = posts.findIndex(p => p.id === params.id);
            
            if (postIndex === -1) return;

            const post = posts[postIndex];
            
            // åˆå§‹åŒ–è¯„è®ºæ•°ç»„
            if (!post.comments) post.comments = [];

            // æ·»åŠ æ–°è¯„è®º
            const newComment = {
                id: Date.now().toString(),
                content: commentContent,
                author: {
                    id: currentUser.id,
                    username: currentUser.username
                },
                createdAt: new Date().toISOString()
            };

            post.comments.unshift(newComment);

            // ä¿å­˜æ•°æ®
            localStorage.setItem('posts', JSON.stringify({ posts: posts }));
            
            // æ›´æ–°UI
            document.getElementById('comment-content').value = '';
            document.getElementById('post-comments-count').textContent = post.comments.length;
            loadComments(post.comments);
            showNotification('è¯„è®ºå‘å¸ƒæˆåŠŸï¼', 'success');
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¹¶æ›´æ–°å¯¼èˆªæ 
            if (typeof checkUserLogin === 'function') {
                checkUserLogin();
            } else {
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    updateUILoggedIn();
                } else {
                    updateUILoggedOut();
                }
            }

            // åŠ è½½å¸–å­è¯¦æƒ…
            loadPostDetail();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('like-btn').addEventListener('click', handleLike);
            document.getElementById('submit-comment').addEventListener('click', handleCommentSubmit);

            // ä¸ºæ–‡ç« é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('articles-link').addEventListener('click', function(e) {
                e.preventDefault();
                alert('æ–‡ç« åŠŸèƒ½å³å°†ä¸Šçº¿');
            });
        });
    </script>
</body>
</html>